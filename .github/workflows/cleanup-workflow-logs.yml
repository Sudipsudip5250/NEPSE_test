name: Cleanup Workflow Logs

on:
  schedule:
    - cron: '0 0 * * 6'  # Every Saturday at 00:00 UTC
  workflow_dispatch:      # Allow manual trigger too

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write      # Needed to delete workflow runs
      contents: read

    steps:
      - name: Delete old workflow runs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "Fetching workflow runs for $REPO..."
          page=1
          while true; do
            runs=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
                         -H "Accept: application/vnd.github+json" \
                         "https://api.github.com/repos/$REPO/actions/runs?per_page=100&page=$page" \
                   | jq -r '.workflow_runs[].id')

            if [ -z "$runs" ]; then
              echo "No more runs to delete."
              break
            fi

            for run_id in $runs; do
              echo "Deleting run ID: $run_id"
              curl -s -X DELETE -H "Authorization: Bearer $GITHUB_TOKEN" \
                   -H "Accept: application/vnd.github+json" \
                   "https://api.github.com/repos/$REPO/actions/runs/$run_id"
              sleep 1
            done

            page=$((page + 1))
          done
          echo "âœ… Cleanup complete!"
